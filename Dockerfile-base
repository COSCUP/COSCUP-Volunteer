# FIXME: multi-stage build
FROM alpine:3.15.0

WORKDIR /app

# Install dependencies with apk.
RUN \
  apk update && apk upgrade                                   && \
  apk add --no-cache python3 ca-certificates libmemcached-dev && \
  apk add --no-cache --virtual .build-deps curl cmake zlib-dev   \
          g++ make gcc musl-dev python3-dev libffi-dev openssl-dev

# Prepare `jemalloc`
RUN wget https://github.com/jemalloc/jemalloc/releases/download/5.2.1/jemalloc-5.2.1.tar.bz2 && \
  tar xvjf jemalloc-5.2.1.tar.bz2 && cd jemalloc-5.2.1 && ./configure && make && make install && \
  cd ../ && rm -rf ./jemalloc*

# Prepare `pip`
RUN curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py     && \
  python3 get-pip.py                                          && \
  rm get-pip.py

# Install `poetry`
RUN pip install poetry

# Install PIP dependencies
ADD pyproject.toml poetry.lock /app/
RUN poetry install

# Cleanup
RUN apk del .build-deps && \
    rm -rf /var/cache/apk/* /var/lib/apk/* /etc/apk/cache/*
