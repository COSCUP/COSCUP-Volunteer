{% extends "team.html" %}
{% block head_title_team %}規劃{% endblock %}
{% block menu_plan %}is-active{% endblock %}
{% block team_body %}
<div class="content">
    <article class="message is-dark">
        <div class="message-body">
            用 timeline 的方式呈現時程表，欄位依序為 title, start, end(可不填), desc(可不填)。 title 一樣會合併在同一條的時間線。
            也可以使用「匯入其他組別」顯示其他組別已規劃的項目。
        </div>
    </article>
    <form id="planform">
        <div class="field is-horizontal" v-for="raw in data">
            <div class="field-body">
                <div class="field">
                    <div class="control">
                        <input class="input" type="text" placeholder="title" v-model="raw.title">
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <input class="input" type="date" v-model="raw.start">
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <input class="input" type="date" v-model="raw.end">
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <input class="input" type="text" placeholder="desc" v-model="raw.desc">
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <a class="button" v-on:click="delraw(raw)">
                            <span class="icon"><i class="far fa-trash-alt"></i></span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="field">
            <a class="button is-fullwidth is-info is-light" v-on:click="addraw">
                <span class="icon"><i class="fas fa-plus-circle"></i></span>
                <span>新增</span>
            </a>
        </div>
        <div class="field">
            <a class="button is-fullwidth is-success is-light" v-on:click="save">
                <span class="icon"><i class="far fa-save"></i></span>
                <span>儲存與更新圖表</span>
            </a>
        </div>
        <div class="field">
            <label class="checkbox">
                <input type="checkbox" v-model="importOthers">
                <span class="icon"><i class="fas fa-file-download"></i></span>
                <span>匯入其他組別</span>
            </label>
        </div>
    </form>
</div>
<div class="content">
    <div id="timeline" style="height: 480px;"></div>
</div>
{% endblock %}
{% block js %}
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="/js/axios.min.js"></script>
<script>
    (function () {
        let $planform= new Vue({
            el: '#planform',
            data: {
                data: [],
                others: [],
                baseFormat: {},
                importOthers: false,
                chart: null
            },
            mounted: function() {
                axios.post('./edit?_t=' + Date.now(), {data: this.data, case: 'get', import_others: this.importOthers}).then(function(resp) {
                    $planform.data = resp.data.data;
                    $planform.baseFormat = resp.data.default;
                }).then(function() {
                    google.charts.load("current", {packages:["timeline"]});
                    google.charts.setOnLoadCallback($planform.drawChart);
                });
            },
            watch: {
                importOthers: function() {
                    this.save();
                }
            },
            methods: {
                addraw: function() {
                    this.data.push(Object.assign({}, this.baseFormat));
                },
                delraw: function(raw) {
                    if (window.confirm('確定是否刪除「'+raw.title+'」？（無法恢復喔！）')) {
                        this.data.splice(this.data.indexOf(raw), 1);
                    }
                },
                save: function() {
                    axios.post('./edit?_t='+Date.now(), {data: this.data, case: 'post', import_others: this.importOthers}).then(function(resp) {
                        $planform.data = resp.data.data;
                        $planform.baseFormat = resp.data.default;
                        $planform.others = resp.data.others;
                    }).then(function() {
                        $planform.showchart();
                    });
                },
                drawChart: function() {
                    if (this.chart === null ) {
                        this.chart = new google.visualization.Timeline(document.getElementById('timeline'));
                    }
                    this.chart.clearChart();
                    let dataTable = new google.visualization.DataTable();

                    dataTable.addColumn({ type: 'string', id: 'Name' });
                    dataTable.addColumn({ type: 'string', id: 'Desc' });
                    dataTable.addColumn({ type: 'date', id: 'Start' });
                    dataTable.addColumn({ type: 'date', id: 'End' });

                    let allData = new Array();
                    allData.push.apply(allData, this.data);
                    if (this.importOthers === true) {
                        allData.push.apply(allData, this.others);
                    }

                    allData.forEach(function(raw){
                        if (raw.start === raw.end || raw.end === '') {
                            let start = new Date(raw.start);
                            let end = new Date(raw.start);
                            end.setDate(end.getDate() + 1);
                            if ($planform.importOthers === true) {
                                dataTable.addRow([raw.title+'('+raw.team_name+')', raw.title+'('+raw.desc+' '+raw.team_name+')', start, end]);
                            } else {
                                dataTable.addRow([raw.title, raw.title+'('+raw.desc+')', start, end]);
                            }
                        } else {
                            if ($planform.importOthers === true) {
                                dataTable.addRow([raw.title+'('+raw.team_name+')', raw.title+'('+raw.desc+' '+raw.team_name+')', new Date(raw.start), new Date(raw.end)]);
                            } else {
                                dataTable.addRow([raw.title, raw.title+'('+raw.desc+')', new Date(raw.start), new Date(raw.end)]);
                            }
                        }
                    });

                    this.chart.draw(dataTable, {fontSize: 20});
                },
                showchart: function() {
                    google.charts.setOnLoadCallback(this.drawChart);
                }
            },
            delimiters: ['[[', ']]']
        });
    })();
</script>
{% endblock %}
